#!/bin/bash

# --- Configuration ---
# The remote URL containing the list of valid HWID keys (one per line).
HWID_URL="https://raw.githubusercontent.com/yessirrrrrrrrasdfadfgnkjrwgn/macsploithwid/refs/heads/main/hwid"

# The local file path on the desktop to cache the successful HWID key.
# This file is checked first to allow immediate access on subsequent runs.
CACHE_FILE="${HOME}/Desktop/hwid_key.txt"

# --- Authentication Logic ---

# 1. Check if the local cache file exists and contains a valid key.
if [[ -f "$CACHE_FILE" ]]; then
    # Read the cached key to show what was used for access, but the main point is the file exists.
    CACHED_HWID=$(<"$CACHE_FILE")
    echo "üîë Cached key found. Access granted immediately."
    echo "good"
    exit 0
fi

# 2. If no cache file, prompt the user for the key.
# FIX: Using 'read -r -p' to ensure the prompt is displayed, combined with
# < /dev/tty to force the input to come from the terminal, even when piped.
read -r -p "üîë Please enter a hwid key: " USER_INPUT_KEY < /dev/tty

if [[ -z "$USER_INPUT_KEY" ]]; then
    echo "‚ùå Key cannot be empty. Access denied."
    exit 1
fi

echo "üîç Checking key against remote list..."

# 3. Fetch the content from the remote URL.
# The output is piped through 'tr -d "\r"' to remove potential Windows carriage returns,
# ensuring a clean line-by-line match with the key later.
REMOTE_HWIDS=$(curl --silent --fail --max-time 10 "$HWID_URL" | tr -d '\r')

# Check if curl succeeded (exit code 0)
if [[ $? -ne 0 ]]; then
    echo "‚ùå Failed to fetch the HWID list from the server. Check your network or the URL."
    exit 1
fi

# 4. Check if the user's input key matches any line in the remote list.
# The 'grep -Fxq' command performs an exact, fixed-string search (-F) that matches the
# key against the WHOLE line (-x) of the remote content.
echo "$REMOTE_HWIDS" | grep -Fxq "$USER_INPUT_KEY"

if [[ $? -eq 0 ]]; then
    # Key is correct!
    echo "‚úÖ Key matched."
    echo "good"

    # 5. Save the valid key to the desktop cache file as requested.
    echo "$USER_INPUT_KEY" > "$CACHE_FILE"
    echo "üìù HWID key saved to: $CACHE_FILE for future use."
else
    # Key is incorrect.
    echo "‚ùå Key does not match any entry in the remote list. Access denied."
    exit 1
fi
